<div class="container mx-auto px-4 sm:px-6 lg:px-8">
    <div class="sm:flex sm:items-center sm:justify-between mb-8">
        <div class="sm:flex-auto">
            <h1 class="text-3xl font-bold text-gray-800">Colaboradores</h1>
            <p class="mt-2 text-sm text-gray-600">Uma lista de todos os colaboradores no sistema.</p>
        </div>
        <div class="mt-4 sm:ml-16 sm:mt-0 sm:flex-none">
            <a href="/admin/colaboradores/novo" class="btn-primary">
                Adicionar Colaborador
            </a>
        </div>
    </div>

    <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="table-header">Nome</th>
                        <th scope="col" class="table-header">Setor</th>
                        <th scope="col" class="table-header">Status</th>
                        <th scope="col" class="relative py-3.5 pl-3 pr-4 sm:pr-6"><span class="sr-only">Editar</span>
                        </th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200 bg-white">
                    <% colaboradores.forEach(colab=> { %>
                        <tr>
                            <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm sm:pl-6">
                                <div class="flex items-center">

                                    <div class="h-10 w-10 flex-shrink-0">
                                        <img class="h-10 w-10 rounded-full object-cover"
                                            src="<%= colab.foto_url || '/images/default-avatar.png' %>"
                                            alt="Foto de <%= colab.first_name %>">
                                    </div>

                                    <div class="ml-4">
                                        <div class="font-medium text-gray-900">
                                            <%= colab.first_name %>
                                                <%= colab.last_name %>
                                        </div>
                                        <div class="text-gray-500">
                                            <%= colab.email %>
                                        </div>
                                    </div>

                                </div>
                            </td>
                            <td class="table-cell">
                                <%= colab.setor_nome %>
                            </td>
                            <td class="table-cell">
                                <button type="button"
                                    class="toggle-status-btn inline-flex rounded-full px-2 text-xs font-semibold leading-5 <%= colab.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800' %>"
                                    data-id="<%= colab.id %>" data-active="<%= colab.is_active %>">
                                    <%= colab.is_active ? 'Ativo' : 'Inativo' %>
                                </button>
                            </td>
                            <td
                                class="relative whitespace-nowrap py-4 pl-3 pr-4 text-right text-sm font-medium sm:pr-6">
                                <a href="/admin/colaboradores/editar/<%= colab.id %>"
                                    class="text-blue-600 hover:text-blue-900">Editar</a>
                            </td>
                        </tr>
                        <% }) %>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const tabela = document.querySelector('tbody');

    tabela.addEventListener('click', async (event) => {
        // Verifica se o clique foi num botão de status
        if (event.target.classList.contains('toggle-status-btn')) {
            const button = event.target;
            const profileId = button.dataset.id;
            const currentStatus = button.dataset.active === 'true';
            const newStatus = !currentStatus;

            try {
                // Faz a chamada à nossa nova API
                const response = await fetch(`/admin/colaboradores/${profileId}/status`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ isActive: newStatus })
                });

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.message || 'Falha ao atualizar o status.');
                }

                // Se deu certo, atualiza o botão na tela
                button.dataset.active = newStatus;
                button.textContent = newStatus ? 'Ativo' : 'Inativo';
                
                // Remove as classes de cor antigas e adiciona as novas
                button.classList.remove(currentStatus ? 'bg-green-100' : 'bg-red-100', currentStatus ? 'text-green-800' : 'text-red-800');
                button.classList.add(newStatus ? 'bg-green-100' : 'bg-red-100', newStatus ? 'text-green-800' : 'text-red-800');

            } catch (error) {
                console.error('Erro:', error);
                alert('Não foi possível alterar o status do colaborador.');
            }
        }
    });
});
</script>