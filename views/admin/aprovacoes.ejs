<div class="page-header">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
        <div>
            <h1 class="page-title">
                <i class="fas fa-clipboard-check text-red-600 mr-3"></i>
                Solicitações Pendentes
            </h1>
            <p class="page-description">Aprovações que necessitam de sua análise.</p>
        </div>
        <div class="mt-4 sm:mt-0">
            <button onclick="approveAllPending()" class="btn-success btn-sm">
                <i class="fas fa-check-double mr-2"></i>
                Aprovar Todas
            </button>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-body p-0">
        <div class="table-container">
            <table class="min-w-full">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="table-header">Colaborador</th>
                        <th class="table-header hidden sm:table-cell">Setor</th>
                        <th class="table-header">Data/Hora</th>
                        <th class="table-header">Tipo</th>
                        <th class="table-header text-right">Ações</th>
                    </tr>
                </thead>
                <tbody id="solicitacoes-tbody">
                    <% if (solicitacoes && solicitacoes.length > 0) { %>
                        <% solicitacoes.forEach(mov => { %>
                            <tr id="mov-row-<%= mov.id %>" class="table-row">
                                <td class="table-cell">
                                    <div class="flex items-center space-x-3">
                                        <img src="<%= mov.foto_url || '/images/default-avatar.png' %>" 
                                             alt="<%= mov.colaborador_nome %>" 
                                             class="w-8 h-8 rounded-full object-cover">
                                        <div>
                                            <div class="font-semibold text-gray-900"><%= mov.colaborador_nome %></div>
                                            <div class="text-sm text-gray-500 sm:hidden"><%= mov.setor_nome %></div>
                                        </div>
                                    </div>
                                </td>
                                <td class="table-cell hidden sm:table-cell">
                                    <span class="badge badge-info"><%= mov.setor_nome %></span>
                                </td>
                                <td class="table-cell">
                                    <div class="text-sm">
                                        <div class="font-medium"><%= new Date(mov.data_movimentacao).toLocaleDateString('pt-BR', {timeZone: 'UTC'}) %></div>
                                        <div class="text-gray-500"><%= mov.hora_total %></div>
                                    </div>
                                </td>
                                <td class="table-cell">
                                    <span class="badge <%= mov.entrada ? 'badge-success' : 'badge-danger' %>">
                                        <i class="fas fa-<%= mov.entrada ? 'sign-in-alt' : 'sign-out-alt' %> mr-1"></i>
                                        <%= mov.entrada ? 'Entrada' : 'Saída' %>
                                    </span>
                                </td>
                                <td class="table-cell text-right">
                                    <div class="flex items-center justify-end space-x-2">
                                        <button class="btn-success btn-xs btn-approve" data-id="<%= mov.id %>" title="Aprovar">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        <button class="btn-danger btn-xs btn-reject" data-id="<%= mov.id %>" title="Rejeitar">
                                            <i class="fas fa-times"></i>
                                        </button>
                                        <button class="btn-secondary btn-xs" onclick="viewMovementDetails('<%= mov.id %>')" title="Detalhes">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        <% }) %>
                    <% } else { %>
                        <tr>
                            <td colspan="5" class="table-cell text-center py-12">
                                <div class="text-gray-400">
                                    <i class="fas fa-check-circle text-4xl mb-4"></i>
                                    <p class="text-lg font-medium">Nenhuma solicitação pendente</p>
                                    <p class="text-sm">Todas as aprovações estão em dia!</p>
                                </div>
                            </td>
                        </tr>
                    <% } %>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const tabelaSolicitacoes = document.getElementById('solicitacoes-tbody');
        if (tabelaSolicitacoes) {
            tabelaSolicitacoes.addEventListener('click', async (event) => {
                const target = event.target;
                const movementId = target.dataset.id;
                let url = '';
                
                if (target.classList.contains('btn-approve')) {
                    url = `/admin/movimentacoes/${movementId}/aprovar`;
                } else if (target.classList.contains('btn-reject')) {
                    url = `/admin/movimentacoes/${movementId}/rejeitar`;
                } else {
                    return;
                }

                if (!movementId || !url) return;

                target.disabled = true;
                
                try {
                    const response = await fetch(url, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' }
                    });

                    const result = await response.json();

                    if (!result.success) {
                        throw new Error(result.message || 'Falha ao processar a solicitação.');
                    }

                    const rowToRemove = document.getElementById(`mov-row-${movementId}`);
                    if (rowToRemove) {
                        rowToRemove.style.opacity = '0';
                        setTimeout(() => rowToRemove.remove(), 300);
                    }

                } catch (error) {
                    console.error('Erro:', error);
                    alert('Não foi possível processar a solicitação.');
                    target.disabled = false;
                }
            });
        }
    });

    // Funções auxiliares (pode estar em um arquivo js global)
    async function viewMovementDetails(movementId) {
        // Implementar lógica para abrir modal com detalhes
        console.log('Ver detalhes da movimentação:', movementId);
        alert('Funcionalidade de detalhes em desenvolvimento.');
    }
    async function approveAllPending() {
        if (!confirm('Tem certeza que deseja aprovar TODAS as solicitações pendentes?')) {
            return;
        }
        try {
            const response = await fetch('/admin/movimentacoes/aprovar-todas', {
                method: 'PATCH',
            });
            const result = await response.json();
            if (result.success) {
                alert(`${result.approved} movimentações aprovadas com sucesso!`);
                location.reload();
            } else {
                throw new Error(result.message);
            }
        } catch (error) {
            console.error('Erro ao aprovar todas as movimentações:', error);
            alert('Não foi possível processar a solicitação em massa.');
        }
    }
</script>