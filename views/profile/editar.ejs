<div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8 max-w-2xl">

    <% if (success_msg && success_msg.length > 0) { %>
    <div class="alert alert-success mb-6 animate-fade-in">
        <i class="fas fa-check-circle mr-2"></i>
        <%= success_msg %>
    </div>
    <% } %>
    <% if (error_msg && error_msg.length > 0) { %>
    <div class="alert alert-danger mb-6 animate-fade-in">
        <i class="fas fa-exclamation-circle mr-2"></i>
        <%= error_msg %>
    </div>
    <% } %>
    
    <div class="page-header">
        <div class="flex items-center justify-between flex-wrap">
            <h1 class="page-title">
                <i class="fas fa-user-circle text-red-600 mr-3"></i>
                Editar Meu Perfil
            </h1>
            <a href="/meu-perfil" class="btn-secondary btn-sm mt-3 sm:mt-0">
                <i class="fas fa-home mr-2"></i>
                Voltar para a Home
            </a>
        </div>
        <p class="page-description">Gerencie as suas informações pessoais e de contato.</p>
    </div>

    <form action="/profile/foto" method="POST" enctype="multipart/form-data" id="form-foto" class="card mb-6">
        <div class="card-body">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Foto do Perfil</h2>
            <div class="flex items-center space-x-6 flex-wrap">
                <img class="h-24 w-24 rounded-full object-cover border-2 border-gray-200 shadow-sm"
                    src="<%= profile.foto_url || '/images/default-avatar.png' %>" alt="Foto do Perfil">
                <div class="flex-1 min-w-0 mt-4 md:mt-0">
                    <input type="file" name="foto" id="foto-input"
                        class="text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-red-50 file:text-red-700 hover:file:bg-red-100" />
                    <p class="text-xs text-gray-500 mt-1">PNG, JPG ou GIF (Max. 2MB). A foto será enviada automaticamente ao ser selecionada.</p>
                </div>
            </div>
        </div>
    </form>

    <form action="/profile/editar" method="POST" class="space-y-6">

        <div class="card">
            <div class="card-body">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Dados Pessoais</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="nome" class="form-label">Nome Completo</label>
                        <input type="text" name="nome" id="nome" class="form-input" value="<%= profile.nome %>" required>
                    </div>
                    <div>
                        <label for="email" class="form-label">Email</label>
                        <input type="email" name="email" id="email" class="form-input" value="<%= user.email %>" required>
                    </div>
                    <div>
                        <label for="data_nascimento" class="form-label">Data de Nascimento</label>
                        <input type="date" name="data_nascimento" id="data_nascimento" class="form-input"
                            value="<%= profile.data_nascimento ? new Date(profile.data_nascimento).toISOString().split('T')[0] : '' %>">
                    </div>
                    <div>
                        <label for="sexo" class="form-label">Sexo</label>
                        <select name="sexo" id="sexo" class="form-input">
                            <option value="">Prefiro não informar</option>
                            <option value="Masculino" <%= profile.sexo === 'Masculino' ? 'selected' : '' %>>Masculino</option>
                            <option value="Feminino" <%= profile.sexo === 'Feminino' ? 'selected' : '' %>>Feminino</option>
                        </select>
                    </div>
                    <div>
                        <label for="cpf" class="form-label">CPF (Opcional)</label>
                        <input type="text" name="cpf" id="cpf" class="form-input" placeholder="000.000.000-00" value="<%= profile.cpf || '' %>">
                    </div>
                    <div>
                        <label for="telefone" class="form-label">Telefone Celular</label>
                        <input type="text" name="telefone" id="telefone" class="form-input" placeholder="(00) 00000-0000" value="<%= profile.telefone || '' %>">
                    </div>
                    <div class="md:col-span-2">
                        <label for="linkedin" class="form-label">LinkedIn (URL)</label>
                        <input type="url" name="linkedin" id="linkedin" class="form-input" placeholder="https://linkedin.com/in/seu-perfil" value="<%= profile.linkedin || '' %>">
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Endereço</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="cep" class="form-label">CEP</label>
                        <input type="text" name="cep" id="cep" class="form-input" value="<%= profile.cep || '' %>">
                    </div>
                    <div>
                        <label for="numero" class="form-label">Número</label>
                        <input type="text" name="numero" id="numero" class="form-input" value="<%= profile.numero || '' %>">
                    </div>
                    <div class="md:col-span-2">
                        <label for="logradouro" class="form-label">Nome da Rua</label>
                        <input type="text" name="logradouro" id="logradouro" class="form-input" value="<%= profile.logradouro || '' %>">
                    </div>
                    <div>
                        <label for="bairro" class="form-label">Bairro</label>
                        <input type="text" name="bairro" id="bairro" class="form-input" value="<%= profile.bairro || '' %>">
                    </div>
                    <div>
                        <label for="cidade" class="form-label">Cidade</label>
                        <input type="text" name="cidade" id="cidade" class="form-input" value="<%= profile.cidade || '' %>">
                    </div>
                    <div>
                        <label for="estado" class="form-label">Estado</label>
                        <input type="text" name="estado" id="estado" class="form-input" maxlength="2" value="<%= profile.estado || '' %>">
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Informações Organizacionais</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="form-label">Setor</label>
                        <input type="text" class="form-input bg-gray-100" value="<%= profile.setor_nome || 'Não definido' %>" disabled>
                    </div>
                    <div>
                        <label for="funcao" class="form-label">Função / Cargo</label>
                        <input type="text" name="funcao" id="funcao" class="form-input" value="<%= profile.funcao || '' %>">
                    </div>
                </div>
            </div>
        </div>
        
        <div class="flex justify-end pt-4 space-x-3">
            <a href="/dashboard" class="btn-secondary">Cancelar</a>
            <button type="submit" class="btn-primary">Salvar Alterações</button>
        </div>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Lógica do upload automático da foto
        const formFoto = document.getElementById('form-foto');
        const inputFoto = document.getElementById('foto-input');

        if (formFoto && inputFoto) {
            inputFoto.addEventListener('change', () => {
                formFoto.submit();
            });
        }
        
        // Lógica de preenchimento de CEP
        const cepInput = document.getElementById('cep');
        if (cepInput) {
            cepInput.addEventListener('blur', async () => {
                let cep = cepInput.value.replace(/\D/g, '');
                if (cep.length !== 8) return;

                try {
                    const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                    const data = await response.json();
                    
                    if (!data.erro) {
                        document.getElementById('logradouro').value = data.logradouro || '';
                        document.getElementById('bairro').value = data.bairro || '';
                        document.getElementById('cidade').value = data.localidade || '';
                        document.getElementById('estado').value = data.uf || '';
                    } else {
                        alert('CEP não encontrado.');
                    }
                } catch (error) {
                    console.error('Erro ao buscar CEP:', error);
                    alert('Erro ao buscar CEP. Por favor, tente novamente.');
                }
            });
        }
    });
</script>