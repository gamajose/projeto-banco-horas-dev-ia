<div class="page-header">
    <h1 class="page-title">
        <i class="fas fa-calendar-alt text-red-600 mr-3"></i>
        Minha Escala
    </h1>
    <p class="page-description">Consulte a sua escala de trabalho, folgas e férias.</p>
</div>

<div class="card mb-6">
    <div class="card-body flex flex-col sm:flex-row items-center justify-between gap-4">
        <div class="flex items-center space-x-2">
            <button id="prev-month-btn" class="btn-secondary btn-sm !py-2 !px-3"><i class="fas fa-chevron-left"></i></button>
            <h2 id="current-month-year" class="text-xl font-bold text-gray-800 w-48 text-center"></h2>
            <button id="next-month-btn" class="btn-secondary btn-sm !py-2 !px-3"><i class="fas fa-chevron-right"></i></button>
        </div>
        <div class="flex items-center flex-wrap gap-x-3 gap-y-2">
            <div class="flex items-center"><div class="w-3 h-3 bg-emerald-100 rounded-sm mr-1.5 border"></div><span class="text-xs">Trabalho</span></div>
            <div class="flex items-center"><div class="w-3 h-3 bg-red-100 rounded-sm mr-1.5 border"></div><span class="text-xs">Folga</span></div>
            <div class="flex items-center"><div class="w-3 h-3 bg-purple-100 rounded-sm mr-1.5 border"></div><span class="text-xs">Férias</span></div>
            <div class="flex items-center"><div class="w-3 h-3 bg-orange-100 rounded-sm mr-1.5 border"></div><span class="text-xs">Standby</span></div>
            <div class="flex items-center"><div class="w-3 h-3 bg-yellow-100 rounded-sm mr-1.5 border"></div><span class="text-xs">Feriado</span></div>
            <div class="flex items-center"><div class="w-3 h-3 bg-gray-100 rounded-sm mr-1.5 border"></div><span class="text-xs">Fim de Semana</span></div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-body p-0">
        <div id="escala-container" class="table-container overflow-x-auto">
            <div class="p-12 text-center text-gray-500">
                <i class="fas fa-spinner fa-spin text-3xl"></i>
                <p class="mt-2">A carregar a sua escala...</p>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- CONFIGURAÇÕES E ESTADO ---
    const colaborador = <%- JSON.stringify(userProfile) %>;
    let currentDate = new Date();
    let currentEscalas = [];
    let currentAniversariantes = [];

    const feriados = {
        '1-1': 'Ano Novo', '4-21': 'Tiradentes', '5-1': 'Dia do Trabalho',
        '9-7': 'Independência', '10-12': 'N. S. Aparecida', '11-2': 'Finados',
        '11-15': 'Proclamação da República', '12-25': 'Natal'
    };

    // --- ELEMENTOS DO DOM ---
    const container = document.getElementById('escala-container');
    const monthYearEl = document.getElementById('current-month-year');
    const prevBtn = document.getElementById('prev-month-btn');
    const nextBtn = document.getElementById('next-month-btn');

    // --- RENDERIZAÇÃO DA GRELHA ---
    const renderEscala = () => {
        const ano = currentDate.getFullYear();
        const mes = currentDate.getMonth();
        monthYearEl.textContent = `${currentDate.toLocaleString('pt-BR', { month: 'long' })} de ${ano}`.replace(/^\w/, c => c.toUpperCase());
        const diasNoMes = new Date(ano, mes + 1, 0).getDate();

        let headerHtml = `<th class="sticky left-0 bg-gray-50 z-10 p-2 text-left text-sm font-semibold text-gray-800 w-48 min-w-48">Colaborador</th>`;
        for (let dia = 1; dia <= diasNoMes; dia++) {
            const data = new Date(ano, mes, dia);
            const diaSemana = data.toLocaleDateString('pt-BR', { weekday: 'short' }).substring(0, 3);
            const isWeekend = [0, 6].includes(data.getDay());
            headerHtml += `<th class="p-1 md:p-2 text-center text-xs md:text-sm font-medium ${isWeekend ? 'bg-gray-200' : 'bg-gray-50'}"><div class="w-8 md:w-10">${diaSemana}</div><div>${dia}</div></th>`;
        }

        let bodyHtml = `<tr><td class="sticky left-0 bg-white z-10 p-1 md:p-2 border-b whitespace-nowrap"><div class="font-semibold text-sm">${colaborador.nome}</div><div class="text-xs text-gray-500">${colaborador.funcao || 'N/D'}</div></td>`;
        for (let dia = 1; dia <= diasNoMes; dia++) {
            const data = new Date(ano, mes, dia);
            const dataStr = `${ano}-${(mes + 1).toString().padStart(2, '0')}-${dia.toString().padStart(2, '0')}`;
            const escalaDoDia = currentEscalas.find(e => e.data && e.data.startsWith(dataStr));
            const isAniversario = currentAniversariantes.some(a => a.perfil_id === colaborador.id && a.dia === dia);
            const isFeriado = feriados[`${mes + 1}-${dia}`];

            let cellClass = 'border-b p-1 md:p-2 text-center relative h-14';
            let cellContent = '';

            if (isAniversario) cellClass += ' bg-pink-100';
            else if (isFeriado && !escalaDoDia) cellClass += ' bg-yellow-100';
            else if ([0, 6].includes(data.getDay()) && !escalaDoDia) cellClass += ' bg-gray-100';
            
            if (isAniversario) {
                cellContent += `<i class="fas fa-birthday-cake text-pink-500 absolute top-1 right-1 text-xs" title="Aniversário!"></i>`;
            }

            if (escalaDoDia) {
                switch (escalaDoDia.tipo_escala) {
                    case 'Trabalho':
                        cellClass += ' bg-emerald-50';
                        cellContent += `<div class="font-mono text-2xs md:text-xs">${escalaDoDia.hora_inicio || ''} - ${escalaDoDia.hora_fim || ''}</div>`;
                        break;
                    case 'Folga':
                        cellClass += ' bg-red-100';
                        cellContent += `<div class="font-bold text-blue-800">F</div>`;
                        break;
                    case 'Férias':
                        cellClass += ' bg-purple-100';
                        cellContent += `<div class="font-bold text-purple-800">FR</div>`;
                        break;
                    case 'Standby':
                        cellClass += ' bg-orange-100';
                        cellContent += `<div class="font-bold text-orange-800">ST</div>`;
                        break;
                }
            } else if (isFeriado) {
                cellContent += `<div class="flex flex-col items-center justify-center h-full"><span class="font-bold text-yellow-800 text-xs">FD</span><span class="text-[10px] text-yellow-600 hidden sm:block">${feriados[`${mes + 1}-${dia}`]}</span></div>`;
            }

            bodyHtml += `<td class="${cellClass}">${cellContent}</td>`;
        }
        bodyHtml += '</tr>';
        
        container.innerHTML = `<table class="min-w-full text-xs"><thead><tr>${headerHtml}</tr></thead><tbody>${bodyHtml}</tbody></table>`;
    };

    // --- BUSCA DE DADOS ---
    const carregarDadosEscala = async () => {
        container.innerHTML = `<div class="p-12 text-center text-gray-500"><i class="fas fa-spinner fa-spin text-3xl"></i><p class="mt-2">A carregar a sua escala...</p></div>`;
        const ano = currentDate.getFullYear();
        const mes = currentDate.getMonth() + 1;
        try {
            const response = await fetch(`/profile/api/escala?ano=${ano}&mes=${mes}`);
            const result = await response.json();
            if (result.success) {
                currentEscalas = result.escalas;
                currentAniversariantes = result.aniversariantes;
                renderEscala();
            } else {
                throw new Error(result.message);
            }
        } catch (error) {
            container.innerHTML = `<div class="p-12 text-center text-red-500">${error.message}</div>`;
        }
    };

    // --- EVENT LISTENERS ---
    prevBtn.addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() - 1);
        carregarDadosEscala();
    });
    nextBtn.addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() + 1);
        carregarDadosEscala();
    });
    
    // --- INICIALIZAÇÃO ---
    carregarDadosEscala();
});
</script>